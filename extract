#!/bin/bash

# 2013-09-19 14:33:16,Human,Hunter,Male,Saldaea,16,14,12,15,18

wget -O stats.csv http://wotmad.herokuapp.com/stats/export/ || exit 1
header=$(head -1 stats.csv)
sed -i 1d stats.csv

mapfile -t factions < <(cut -d, -f2 stats.csv | sort | uniq)
mapfile -t classes < <(cut -d, -f3 stats.csv | sort | uniq)
mapfile -t sexes < <(cut -d, -f4 stats.csv | sort | uniq)
mapfile -t homelands < <(cut -d, -f5 stats.csv | sort | uniq)

IFS=,
for faction in ${factions[@]}; do
	[[ ! -d $faction ]] && mkdir $faction
	for class in ${classes[@]}; do
		[[ ! -d $faction/$class ]] && mkdir $faction/$class
		for sex in ${sexes[@]}; do
			[[ ! -d $faction/$class/$sex ]] && mkdir $faction/$class/$sex
			for homeland in ${homelands[@]}; do
				echo "$header" > "$faction/$class/$sex/$homeland.csv"
				grep "$faction,$class,$sex,$homeland" stats.csv >> "$faction/$class/$sex/$homeland.csv" || rm "$faction/$class/$sex/$homeland.csv"
			done
		done
	done
done


