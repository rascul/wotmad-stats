#!/usr/bin/php
<?php

$stats_url = "http://wotmad.herokuapp.com/stats/export/";
#$stats_url = "/tmp/stats.csv";
$stats_dir = "csv";
$html_dir = "../stats-pages/html";
$header = "Submitted,Faction,Class,Sex,Homeland,Strength,Intelligence,Willpower,Dexterity,Constitution,Sum\n";
$stat_files = array();

/* function to recursively remove a directory                  *
 * from http://www.php.net/manual/en/function.rmdir.php#107233 */
function rrmdir($dir) {
	if (is_dir($dir)) {
		$objects = scandir($dir);
		foreach ($objects as $object) {
			if ($object != "." && $object != "..") {
				if (filetype($dir."/".$object) == "dir")
					rrmdir($dir."/".$object);
				else
					unlink($dir."/".$object);
			}
		}
		reset($objects);
		rmdir($dir);
	}
}

// clean up stats and html directories, starting fresh
rrmdir($stats_dir);
rrmdir($html_dir);
mkdir($stats_dir);
mkdir($html_dir);

$count = 1;
foreach (file($stats_url, FILE_SKIP_EMPTY_LINES) as $line) {
	if ($count > 1) {
		$line = trim($line);
		$eline = explode(",", $line);
		
		$faction = $eline[1];
		$class = $eline[2];
		$homeland = $eline[4];
		
		$sum = $eline[5] + $eline[6] + $eline[7] + $eline[8] + $eline[9];
		
		if (!is_dir("$stats_dir/$faction/$class")) {
			echo "[dir] $faction/$class\n";
			mkdir("$stats_dir/$faction/$class", 0755, true);
			mkdir("$html_dir/$faction/$class", 0755, true);
		}
		
		$handle = "";
		if (file_exists("$stats_dir/$faction/$class/$homeland.csv"))
			$handle = fopen("$stats_dir/$faction/$class/$homeland.csv", "a");
		else {
			echo "[csv] $faction/$class/$homeland\n";
			$handle = fopen("$stats_dir/$faction/$class/$homeland.csv", "a");
			fwrite($handle, $header);
			array_push($stat_files, "$faction/$class/$homeland");
		}
		fwrite($handle, "$line,$sum\n");
		fclose($handle);
	}
	$count++;
}

foreach ($stat_files as $file) {
	echo "[html] $file\n";
	$handle = fopen("$html_dir/$file.html", "w");
	$html = "
<html><head><title>$file</title>
<script type=\"text/javascript\" src=\"https://www.google.com/jsapi\"></script>
<script type=\"text/javascript\">google.load('visualization', '1', {packages: ['table', 'corechart']});</script>
<script type=\"text/javascript\">
function drawStatsTable() {
// Create and populate the data table.
var data = google.visualization.arrayToDataTable([
";
	
	fwrite($handle, $html);
	
	$count = 0;
	
	$avg = array();
	$min = array();
	$max = array();
	$total = array();
	
	$sums = array_fill(55, 46, 0);
	$str = array_fill(1, 21, 0);
	$int = array_fill(1, 21, 0);
	$wil = array_fill(1, 21, 0);
	$dex = array_fill(1, 21, 0);
	$con = array_fill(1, 21, 0);
	
	foreach (file("$stats_dir/$file.csv") as $line) {
		$eline = explode(",", trim($line));
		
		if ($count) {
			if ($count == 1) {
				for ($i = 5; $i <= 10; $i++) {
					$min[$i-5] = $eline[$i];
					$max[$i-5] = $eline[$i];
					$total[$i-5] = $eline[$i];
				}
			} elseif ($count > 1) {
				for ($i = 5; $i <= 10; $i++) {
					if ($eline[$i] < $min[$i-5])
						$min[$i-5] = $eline[$i];
					if ($eline[$i] > $max[$i-5])
						$max[$i-5] = $eline[$i];
					$total[$i-5] += $eline[$i];
				}
			}
			
			$sum = $eline[5] + $eline[6] + $eline[7] + $eline[8] + $eline[9];
			$sums[$sum]++;
			$str[$eline[5]]++;
			$int[$eline[6]]++;
			$wil[$eline[7]]++;
			$dex[$eline[8]]++;
			$con[$eline[9]]++;
			
			fwrite($handle, "['$eline[0]','$eline[1]','$eline[2]','$eline[3]','$eline[4]',$eline[5],$eline[6],$eline[7],$eline[8],$eline[9],$eline[10]],\n");
		} else {
			fwrite($handle, "['$eline[0]','$eline[1]','$eline[2]','$eline[3]','$eline[4]','$eline[5]','$eline[6]','$eline[7]','$eline[8]','$eline[9]','$eline[10]'],\n");
		}
		
		$count++;
	}
	
	$count--;
	for ($i = 0; $i <= 5; $i++)
		$avg[$i] = round($total[$i] / $count, 1);
	
	$min[5] = trim($min[5]);
	$max[5] = trim($max[5]);
	$avg[5] = trim($avg[5]);
	
	$html = "

]);      
visualization = new google.visualization.Table(document.getElementById('stat_table'));
visualization.draw(data, {showRowNumber: true});
}
function drawCalcsTable() {
var data = google.visualization.arrayToDataTable([
['','Strength','Intelligence','Willpower','Dexterity','Constitution','Sum'],
['Minimum','$min[0]','$min[1]','$min[2]','$min[3]','$min[4]','$min[5]'],
['Maximum','$max[0]','$max[1]','$max[2]','$max[3]','$max[4]','$max[5]'],
['Average','$avg[0]','$avg[1]','$avg[2]','$avg[3]','$avg[4]','$avg[5]']
]);
visualization = new google.visualization.Table(document.getElementById('calcs_table'));
visualization.draw(data, null);
}
function drawSumsChart() {
var data = google.visualization.arrayToDataTable([
['sum','sum'],
";
	
	fwrite($handle, $html);
	for ($i = 55; $i <= 100; $i++)
		if ($sums[$i])
			fwrite($handle, "[$i,$sums[$i]],\n");
	
	$html = "
]);
new google.visualization.LineChart(document.getElementById('sums_chart')).
draw(data, {curveType: \"function\",
title: 'statsum',
vAxis: {title: 'number of stats'}}
);
}

function drawPhysicalsChart() {
var data = google.visualization.arrayToDataTable([
['stat','str','dex','con'],
";
	
	fwrite($handle, $html);
	
	for ($i = 1; $i <= 21; $i++) 
		if ($str[$i] or $dex[$i] or $con[$i])
			fwrite($handle, "[$i,$str[$i],$dex[$i],$con[$i]],\n");
	
	$html = "
]);
new google.visualization.LineChart(document.getElementById('physicals_chart')).
draw(data, {curveType: \"function\",
title: 'physicals',
vAxis: {title: 'number of stats'}}
);
}

function drawMentalsChart() {
var data = google.visualization.arrayToDataTable([
['stat','int','wil'],
";
	
	fwrite($handle, $html);
	
	for ($i = 1; $i <= 21; $i++) 
		if ($int[$i] or $wil[$i])
			fwrite($handle, "[$i,$int[$i],$wil[$i]],\n");
	
	$html = "
]);
new google.visualization.LineChart(document.getElementById('mentals_chart')).
draw(data, {curveType: \"function\",
title: 'mentals',
vAxis: {title: 'number of stats'}}
);
}

google.setOnLoadCallback(drawSumsChart);
google.setOnLoadCallback(drawStatsTable);
google.setOnLoadCallback(drawCalcsTable);
google.setOnLoadCallback(drawPhysicalsChart);
google.setOnLoadCallback(drawMentalsChart);
google.setOnLoadCallback(drawChart);
</script>
<style>
td { text-align: center; }
</style>
</head>
<body style=\"font-family: Arial;border: 0 none;\">

<table width=\"100%\"><tr>
<td style=\"width: 25%; text-align: left;\">
<h1>$file</h1>
<p><a href=\"https://github.com/rascul/wotmad-stats/tree/master/csv/$file.csv\">csv data</a></p>
<p>Out of $count stats</p>
</td>
<td style=\"text-align: right; width: 25%;\">
<div id=\"physicals_chart\"></div>
</td>
<td style=\"text-align: right; width: 25%;\">
<div id=\"mentals_chart\"></div>
</td>
<td style=\"text-align: right; width: 25%;\">
<div id=\"sums_chart\"></div>
</td>
</tr></table>
<div id=\"calcs_table\"></div>
<br><br>
<div id=\"stat_table\"></div>
</body>
</html>
";
	
	fwrite($handle, $html);
	fclose($handle);

}

// generate index.html
echo "[html] index\n";
if (file_exists("$html_dir/../index.html"))
	unlink("$html_dir/../index.html");
$handle = fopen("$html_dir/../index.html", "a");
$html = "
<html>
<head>
<title>WoTMad Stats</title>
</head>
<body style=\"font-family: Arial;border: 0 none;\">
<h1>WoTMad Stats</h1>
<p>Data is from <a href=\"http://wotmad.herokuapp.com/stats\">WoTMad Stat Database</a></p>
<table style=\"width: 100%;\"><tr valign=\"top\">
";

fwrite($handle, $html);

if (is_dir($html_dir)) {
	$factions = scandir($html_dir);
	sort($factions);
	foreach ($factions as $faction) {
		if ($faction != "." && $faction != ".." && $faction != "index.html") {
			fwrite($handle, "<td><h2>$faction</h2>\n");
			
			$classes = scandir("$html_dir/$faction");
			foreach ($classes as $class) {
				if ($class != "." && $class != "..") {
					fwrite($handle, "<h3>$class</h3><ul>\n");
					
					$homelands = scandir("$html_dir/$faction/$class");
					foreach ($homelands as $homeland) {
						if ($homeland != "." && $homeland != "..") {
							$csv_file = file("$stats_dir/$faction/$class/" . basename($homeland, ".html") . ".csv");
							$num_stats = count($csv_file) - 1;
							fwrite($handle, "<li><a href=\"html/$faction/$class/$homeland\">" . basename($homeland, ".html") . "</a> ($num_stats)</li>\n");
						}
					}
					fwrite($handle, "</ul>\n");
				}
			}
			fwrite($handle, "</td>\n");
		}
	}
}

$html = "
</tr></table>
</body>
</html>
";

fwrite($handle, $html);
fclose($handle);

?>
